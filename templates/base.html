<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}PriceGuard Crypto Tracker{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --primary-color: #3b82f6;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --dark-bg: #1f2937;
        --light-bg: #f9fafb;
      }

      body {
        background-color: var(--light-bg);
        min-height: 100vh;
      }

      .navbar {
        background-color: var(--dark-bg) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .sidebar {
        min-height: calc(100vh - 56px);
        background-color: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
      }

      .card {
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .price-positive {
        color: var(--success-color);
      }

      .price-negative {
        color: var(--danger-color);
      }

      .crypto-symbol {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--primary-color), #8b5cf6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .badge-change {
        font-size: 0.9rem;
        padding: 0.35em 0.65em;
      }

      .alert-threshold {
        width: 80px;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>

    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <i class="bi bi-currency-bitcoin fs-3 me-2"></i>
          <span class="fw-bold">PriceGuard</span>
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item nav-auth">
              <a class="nav-link" href="/">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item nav-auth">
              <a class="nav-link" href="/preferences">
                <i class="bi bi-gear"></i> Preferences
              </a>
            </li>
            <li class="nav-item nav-auth">
              <a class="nav-link" href="#" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </a>
            </li>
            <li class="nav-item nav-auth">
              <a class="nav-link" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i> Logout
              </a>
            </li>
            <li class="nav-item nav-guest">
              <a class="nav-link" href="/login">
                <i class="bi bi-box-arrow-in-right"></i> Login
              </a>
            </li>
            <li class="nav-item nav-guest">
              <a class="nav-link" href="/register">
                <i class="bi bi-person-plus"></i> Register
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    {% block content %}{% endblock %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Common JavaScript -->
    <script>
      // API Base URL
      const API_BASE = "/api";

      // Get auth token from localStorage
      function getAuthToken() {
        return localStorage.getItem("auth_token");
      }

      // Set auth token
      function setAuthToken(token) {
        localStorage.setItem("auth_token", token);
        updateNavLinks();
      }

      // Clear auth token
      function clearAuthToken() {
        localStorage.removeItem("auth_token");
        updateNavLinks();
      }

      // Check authentication
      function checkAuth() {
        const token = getAuthToken();
        if (!token) {
          window.location.href = "/login";
          return false;
        }
        return true;
      }

      // Logout
      function logout() {
        clearAuthToken();
        window.location.href = "/login";
      }

      // Toggle nav visibility based on auth
      function updateNavLinks() {
        const authed = !!getAuthToken();
        document.querySelectorAll(".nav-auth").forEach((el) => {
          el.classList.toggle("d-none", !authed);
        });
        document.querySelectorAll(".nav-guest").forEach((el) => {
          el.classList.toggle("d-none", authed);
        });
      }

      document.addEventListener("DOMContentLoaded", updateNavLinks);

      // Make authenticated API request
      async function apiRequest(endpoint, options = {}) {
        const token = getAuthToken();

        const defaultOptions = {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        };

        const mergedOptions = {
          ...defaultOptions,
          ...options,
          headers: {
            ...defaultOptions.headers,
            ...options.headers,
          },
        };

        try {
          const response = await fetch(`${API_BASE}${endpoint}`, mergedOptions);

          if (response.status === 401) {
            logout();
            return null;
          }

          return response;
        } catch (error) {
          console.error("API request error:", error);
          throw error;
        }
      }

      // Format price
      function formatPrice(price) {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
          maximumFractionDigits: 8,
        }).format(price);
      }

      // Format large numbers
      function formatNumber(num) {
        const value = Number(num) || 0;
        if (value >= 1e12) return (value / 1e12).toFixed(2) + "T";
        if (value >= 1e9) return (value / 1e9).toFixed(2) + "B";
        if (value >= 1e6) return (value / 1e6).toFixed(2) + "M";
        if (value >= 1e3) return (value / 1e3).toFixed(2) + "K";
        return num.toFixed(2);
      }

      // Show toast notification
      function showToast(message, type = "info") {
        const toastHTML = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

        let toastContainer = document.getElementById("toastContainer");
        if (!toastContainer) {
          toastContainer = document.createElement("div");
          toastContainer.id = "toastContainer";
          toastContainer.className =
            "toast-container position-fixed bottom-0 end-0 p-3";
          document.body.appendChild(toastContainer);
        }

        const toastElement = document.createElement("div");
        toastElement.innerHTML = toastHTML;
        const toastNode = toastElement.firstElementChild;

        toastContainer.appendChild(toastNode);

        const toast = new bootstrap.Toast(toastNode);
        toast.show();
      }
    </script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
